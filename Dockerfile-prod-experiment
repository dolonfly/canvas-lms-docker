ARG CANVAS_USER=app
ARG CANVAS_HOME=/home/app/canvas

FROM phusion/passenger-customizable:3.0.2 as builderx
# Set correct environment variables.
ENV HOME /root

ARG CANVAS_USER
ARG CANVAS_HOME

RUN /pd_build/nodejs.sh 18
RUN /pd_build/ruby-3.1.*.sh

WORKDIR ${CANVAS_HOME}
RUN <<EOF
git clone -b canvas-self-customization --depth 1 https://github.com/dolonfly/canvas-lms.git ${CANVAS_HOME}

yarn config set network-timeout 600000
yarn config set network-concurrency 1
yarn install # --pure-lockfile --ignore-optional

bundle config set --local path vendor/bundle
bundle install

yarn gulp rev
#Generate Assets
mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands
touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss
touch Gemfile.lock
touch log/production.log
chown -R ${CANVAS_USER} config/environment.rb log tmp public/assets \
                              app/stylesheets/_brandable_variables_defaults_autogenerated.scss \
                              app/stylesheets/brandable_css_brands Gemfile.lock config.ru

RAILS_ENV=production bundle exec rake canvas:compile_assets
#RAILS_ENV=production bundle exec rails js:webpack_production
chown -R ${CANVAS_USER} public/dist/brandable_css

rm -rf \
    .git \
    .github \
    .storybook \
    .vscode \
    build \
    doc \
    docker-compose \
    hooks \
    inst-cli \
    jest \
    log/* \
    node_modules \
    tmp/* \
    ui \
    ui-build
rm \
    .codeclimate.yml \
    .dive-ci \
    .dockerignore \
    .editorconfig \
    .eslintignore \
    .eslintrc.js \
    .git-blame-ignore-revs \
    .gitignore \
    .gitmessage \
    .groovylintrc.json \
    .i18nignore \
    .i18nrc \
    .irbrc \
    .lintstagedrc.js \
    .npmrc \
    .nvmrc \
    .prettierrc \
    .rspec \
    .rubocop.yml \
    .sentryignore \
    .stylelintrc \
    CONTRIBUTING.md \
    COPYRIGHT \
    Dockerfile* \
    Jenkinsfile* \
    LICENSE \
    README.md \
    SECURITY.md \
    bower.json \
    code_of_conduct.md \
    config/*.yml.* \
    docker-compose* \
    gulpfile.js \
    issue_template.md \
    jest.config.js \
    karma.conf.js \
    package.json \
    tsconfig.json \
    webpack.config.js \
    yarn.lock
EOF
